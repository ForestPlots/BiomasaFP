---
title: "Using BiomasaFP and BIOMASS together"
author: "Martin Sullivan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(BiomasaFP)
library(BIOMASS)
```

The BIOMASS R package provides an alternative tool for calculating aboveground biomass. Unlike BiomasaFP, it hasn't been designed to run of ForestPlots.net outputs, which means it requires the user to do a bit more coding, but will be easier to use if your data are not in ForestPlots.net as it doesn't assume that there are particular columns in the data. While for biomass calculations you could use either package, not all functionality overlaps. Only the BIOMASS package provides error propagated estimates of aboveground biomass, while only BiomasaFP provides measures of forest dynamics such as woody productivity. 

While you will probably use one package or the other for your analysis, there are a few useful functions that BIOMASS provides that can be integrated, with a bit of work, into an analysis with BiomasaFP.

## Wood density lookup
The ForestPlots.net database has an inbuilt copy of the Chave/ Zanne et al. 2009 wood density database, which you can access using the query library. This wood density data is one of the required inputs for the mergefp function: 
```{r, echo=TRUE}
dat<-mergefp(trees,md,wd)
```

But the BIOMASS R package also provides a way of querying this database through the `getWoodDensity` function. You might want to do this if you are having problems running the ForestPlots query for wood density, or if you want to change some of the parameters for matching wood density (e.g. not matching at family level, not matching at continent level).

To use the `getWoodDensity` function, our first challange is to split the species column into seperate genus and species columns:

```{r, echo=TRUE}
dat$Genus<-sapply(dat$Species,function(x)strsplit(x," ")[[1]][1])
dat$Sp<-sapply(dat$Species,function(x)strsplit(x," ")[[1]][2])
head(dat$Species)
head(dat$Genus)
head(dat$Sp)
```

Before we run the `getWoodDensity` function, an important step is to reduce the data to just unique tree IDs (if you don't do this, bad things will happen when you try to run `mergefp`).

```{r, echo=TRUE}
dat2<-unique(dat[,c("TreeID","PlotID","PlotCode","PlotViewID","Genus","Sp","Family")])
nrow(dat)
nrow(dat2)
```

Finally, we are ready to run `getWoodDensity`.

```{r, echo=TRUE}
wd.biomass<-getWoodDensity(dat2$Genus,dat2$Sp,stand=dat2$PlotViewID,family=dat2$Family)
str(wd.biomass)
```

Now append the mean wood density for each stem to our data, and then restrict the columns so they match the ForestPlots.net wood density output.

```{r, echo=TRUE}
dat2$WD<-wd.biomass$meanWD
wd2<-data.frame("PlotID"=dat2$PlotID,"PlotCode"=dat2$PlotCode,"PlotViewID"=dat2$PlotViewID,"TreeID"=dat2$TreeID,"WD"=dat2$WD)
```

We can now proceed with `mergefp` as before.

```{r, echo=TRUE}
dat3<-mergefp(trees,md,wd2)
```

## Height-diameter allometry
BIOMASS has nice functions for fitting height-diameter models and plotting fits of different models against the input data.

The first thing we have to do is to covert the diameter data from mm into cm (BiomasaFP height-diameter functions do this in the function, but BIOMASS expects the inputs in cm).

```{r, echo=TRUE}
dat$D.cm<-dat$D4/10
```

You can fit height-diameter models across multiple plots at once in BIOMASS, but you only get the nice graphical output if you look at one plot at a time, so we'll look at each plot in turn.

```{r, echo=TRUE,fig.show='hold'}
with(dat[dat$PlotCode=="JEN-11",],modelHD(D.cm,Height))
with(dat[dat$PlotCode=="CAP-09",],modelHD(D.cm,Height))
```

We can use the RSE and bias values to select the best model, and also use the graphical outputs. 

Let's go with the Michaelis-Menten model to use for both plots. Refit the models specifying which type of model to use, and extract the coefficients.

```{r, echo=TRUE}
m1<-with(dat[dat$PlotCode=="JEN-11",],modelHD(D.cm,Height,method="michaelis"))$coefficients
m2<-with(dat[dat$PlotCode=="CAP-09",],modelHD(D.cm,Height,method="michaelis"))$coefficients
```


Now our challenge is to get this output into a format that can be used with BiomasaFP. The BiomasaFP R package takes a height parameters dataset with the tree ID, a, b and c parameters for each tree, and the type of model for each tree. The code below sets that up:

```{r, echo=TRUE}
h.params2<-data.frame("TreeID"=unique(dat$TreeID),"a_par"=NA,"b_par"=NA,"Model"=NA)
h.params2$a_par[h.params2$TreeID%in%dat$TreeID[dat$PlotCode=="JEN-11"]]<-m1[1,1]
h.params2$b_par[h.params2$TreeID%in%dat$TreeID[dat$PlotCode=="JEN-11"]]<-m1[2,1]
h.params2$Model[h.params2$TreeID%in%dat$TreeID[dat$PlotCode=="JEN-11"]]<-"MicMent"
h.params2$a_par[h.params2$TreeID%in%dat$TreeID[dat$PlotCode=="CAP-09"]]<-m2[1,1]
h.params2$b_par[h.params2$TreeID%in%dat$TreeID[dat$PlotCode=="CAP-09"]]<-m2[2,1]
h.params2$Model[h.params2$TreeID%in%dat$TreeID[dat$PlotCode=="CAP-09"]]<-"MicMent"
# Need a c_par variable
h.params2$c_par<-NA

head(h.params2)
```

Now we can run the `SummaryAGWP` function with the new height data.

```{r, echo=TRUE}
dynamics.mic<-SummaryAGWP(dat,AGBChv14,height.data=h.params2)

summary(dynamics.mic)
```


